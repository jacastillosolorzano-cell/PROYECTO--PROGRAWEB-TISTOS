import{e as M,r as c,j as e,a as B,k as D,l as P,h as J,u as U,B as R}from"./index-2LlJjRq3.js";import{B as A}from"./button-DJt9tRzL.js";import{O as W}from"./OverlayAnimator-B6c3h2kN.js";import{A as G}from"./arrow-left-BNXp1jLN.js";const Y=M("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]),k=[{id:0,label:"+5",coins:5,color:"#ff9ad6"},{id:1,label:"+10",coins:10,color:"#ff66cc"},{id:2,label:"+20",coins:20,color:"#cc66ff"},{id:3,label:"+50",coins:50,color:"#7b2cff"},{id:4,label:"+100",coins:100,color:"#66e0ff"},{id:5,label:"x2",coins:50,color:"#ffd166"}],q=({open:N,costPoints:p,userPoints:g,onClose:s,onPlay:$})=>{const[i,m]=c.useState(!1),[I,j]=c.useState(0),[b,x]=c.useState(null),[T,y]=c.useState(null),[v,o]=c.useState(null),w=360/k.length;c.useEffect(()=>{N||(m(!1),x(null),y(null),o(null),j(0))},[N]);const _=async()=>{if(!i&&!(g<p)){m(!0),x(null),o(null),y(null);try{const{resultado_segmento:f,monedas_ganadas:S}=await $();y(S);const C=k.findIndex(r=>r.label.toLowerCase()===f.toLowerCase()),t=C>=0?C:0,a=(4+Math.floor(Math.random()*3))*360+(360-t*w-w/2);j(a),setTimeout(()=>{const r=k[t];x(r),m(!1)},1900)}catch(f){console.error("Error en ruleta frontend:",f),o(f?.message||"Error al jugar la ruleta"),m(!1),x(null)}}};return N?e.jsxs("div",{style:{position:"fixed",inset:0,zIndex:80,display:"flex",alignItems:"center",justifyContent:"center"},children:[e.jsx("div",{onClick:s,style:{position:"absolute",inset:0,background:"rgba(0,0,0,0.6)"}}),e.jsxs("div",{style:{position:"relative",width:420,background:"#151515",borderRadius:12,padding:18,boxShadow:"0 12px 40px rgba(0,0,0,0.6)",border:"1px solid rgba(120,60,160,0.12)",color:"#fff"},children:[e.jsx("h3",{style:{margin:0},children:"Ruleta de puntos"}),e.jsxs("p",{style:{marginTop:6,color:"#cfc",marginBottom:12},children:["Juega con ",e.jsxs("strong",{children:[p," puntos"]})," para ganar monedas. Tienes"," ",g," pts."]}),e.jsxs("div",{style:{display:"flex",gap:16,alignItems:"center",justifyContent:"center"},children:[e.jsxs("div",{style:{position:"relative",width:260,height:260},children:[e.jsx("div",{style:{width:260,height:260,borderRadius:"50%",overflow:"hidden",transform:`rotate(${I}deg)`,transition:i?"transform 1.9s cubic-bezier(.2,.95,.2,.95)":"none",boxShadow:"0 8px 30px rgba(123,44,255,0.12)"},children:k.map((f,S)=>{const C=S*w;return e.jsx("div",{style:{position:"absolute",left:"50%",top:"50%",width:260,height:260,transformOrigin:"0% 0%",transform:`rotate(${C}deg) translate(-50%, -50%)`,clipPath:"polygon(50% 50%, 0% 100%, 100% 100%)",background:f.color??"#333",display:"flex",alignItems:"flex-end",justifyContent:"center",paddingBottom:28,color:"#111",fontWeight:700,fontSize:14},children:e.jsx("div",{style:{transform:`rotate(${w/2}deg)`},children:f.label})},f.id)})}),e.jsx("div",{style:{position:"absolute",left:"50%",top:"-8px",transform:"translateX(-50%)",width:0,height:0,borderLeft:"12px solid transparent",borderRight:"12px solid transparent",borderBottom:"16px solid #fff"}})]}),e.jsxs("div",{style:{maxWidth:140},children:[e.jsx("div",{style:{marginBottom:8,color:"#ddd"},children:"Resultado"}),e.jsx("div",{style:{minHeight:44,display:"flex",alignItems:"center",justifyContent:"center",background:"#111",borderRadius:8,padding:"8px 10px",textAlign:"center",fontSize:13},children:i?"Girando...":v||(b?`${b.label} â†’ +${T??b.coins} monedas`:"Listo")}),e.jsxs("div",{style:{marginTop:12,display:"flex",gap:8},children:[e.jsx("button",{onClick:s,style:{flex:1,background:"transparent",border:"1px solid rgba(255,255,255,0.06)",padding:8,borderRadius:8,color:"#fff",cursor:"pointer"},children:"Cerrar"}),e.jsx("button",{onClick:_,disabled:i||g<p,style:{flex:1,background:g>=p?"linear-gradient(90deg,#ff66cc,#7b2cff)":"#333",border:"none",color:"#fff",padding:8,borderRadius:8,fontWeight:700,cursor:g>=p?"pointer":"not-allowed"},children:"Jugar"})]})]})]}),e.jsxs("div",{style:{marginTop:12,fontSize:13,color:"#9a9a9a"},children:["Tip: ganas puntos cada vez que envÃ­as mensajes. Ahorra ",p," pts para jugar."]})]})]}):null},E=10,H=1,Q=()=>{const N=B(),{state:p}=D(),g=P(),s=p?.chat,$=g.id??s?.id??"unknown",{toast:i}=J(),[m,I]=c.useState(()=>[{id:"1",text:"Hola, Â¿quÃ© tal?",user:{nombre:s?.nombre??"Contacto"},timestamp:new Date().toISOString()}]),[j,b]=c.useState(""),x=c.useRef(null),[T,y]=c.useState(!1),[v,o]=c.useState(0),{saldo:L,refrescarSaldo:w}=U();c.useEffect(()=>{x.current?.scrollIntoView({behavior:"smooth"})},[m]);const _=()=>{const t=localStorage.getItem("usuario");return t?JSON.parse(t):null},f=_();c.useEffect(()=>{(async()=>{const l=_();if(l)try{const a=await fetch(`${R}/usuarios/${l.id_usuario}/progreso`);if(!a.ok)return;const r=await a.json();if(s?.id){const d=r.find(n=>n.id_streamer===s.id);o(d?.puntos_actuales??0)}else{const d=r.reduce((n,u)=>n+(u.puntos_actuales??0),0);o(d)}}catch(a){console.error("Error obteniendo progreso del usuario:",a)}})()},[s?.id]);const S=async()=>{if(!j.trim())return;const t=j.trim(),l=_();if(!l){i?.({title:"Debes iniciar sesiÃ³n",duration:2e3});return}const a={id:Date.now().toString(),text:t,user:{nombre:"Yo"},timestamp:new Date().toISOString()};I(r=>[...r,a]),b("");try{const r=await fetch(`${R}/usuarios/${l.id_usuario}/mensaje`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id_streamer:s?.id??null,puntos_por_mensaje:H})}),d=await r.json().catch(()=>({}));if(!r.ok){console.error("Error registrando mensaje en backend:",d);return}if(typeof d.puntos_actuales=="number")o(d.puntos_actuales);else if(Array.isArray(d))if(s?.id){const n=d.find(u=>u.id_streamer===s.id);o(n?.puntos_actuales??0)}else{const n=d.reduce((u,h)=>u+(h.puntos_actuales??0),0);o(n)}else{const n=await fetch(`${R}/usuarios/${l.id_usuario}/progreso`);if(n.ok){const u=await n.json();if(s?.id){const h=u.find(O=>O.id_streamer===s.id);o(h?.puntos_actuales??0)}else{const h=u.reduce((O,z)=>O+(z.puntos_actuales??0),0);o(h)}}}i?.({title:"Ganaste puntos por mensaje",duration:1200})}catch(r){console.error("Error al conectar con backend de mensajes:",r)}},C=async()=>{const t=_();if(!t)throw i?.({title:"Inicia sesiÃ³n para jugar",duration:2e3}),new Error("Inicia sesiÃ³n para jugar");try{const l=await fetch(`${R}/ruleta/jugar`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id_espectador:t.id_usuario,puntos_apostados:E,id_streamer:s?.id||null})}),a=await l.json().catch(()=>({}));if(!l.ok){const r=a.error||"Error al procesar la ruleta (Â¿tienes suficientes puntos?)";throw i?.({title:r,duration:2e3}),new Error(r)}if(typeof a.puntos_actuales=="number")o(a.puntos_actuales);else{const r=await fetch(`${R}/usuarios/${t.id_usuario}/progreso`);if(r.ok){const d=await r.json();if(s?.id){const n=d.find(u=>u.id_streamer===s.id);o(n?.puntos_actuales??0)}else{const n=d.reduce((u,h)=>u+(h.puntos_actuales??0),0);o(n)}}}return await w(),window.dispatchEvent(new CustomEvent("tistos:overlay",{detail:{type:"gift",from:t.nombre??t.email??"Anon",giftName:`Ruleta (+${a.monedas_ganadas} monedas)`,points:a.monedas_ganadas,multiplier:0}})),i?.({title:`Â¡Ganaste ${a.monedas_ganadas} monedas!`,description:`Resultado: ${a.resultado_segmento}`,duration:2e3}),{resultado_segmento:a.resultado_segmento,monedas_ganadas:a.monedas_ganadas}}catch(l){console.error(l);const a=l?.message||"Error al procesar la ruleta. IntÃ©ntalo de nuevo.";throw i?.({title:a,duration:2e3}),new Error(a)}};return e.jsxs("div",{className:"min-h-screen bg-background flex flex-col pb-24",children:[e.jsx(W,{}),e.jsxs("div",{className:"flex items-center gap-2 p-4",children:[e.jsx(A,{variant:"ghost",size:"icon",onClick:()=>N(-1),children:e.jsx(G,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex items-center gap-3",children:[s?.avatar?e.jsx("img",{src:s.avatar,alt:s.nombre,className:"w-10 h-10 rounded-full"}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-secondary flex items-center justify-center text-white",children:"U"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:s?.nombre??`Chat ${$}`}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Nivel ",s?.level??"-"]})]})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:10,alignItems:"center"},children:[e.jsxs("div",{style:{color:"#fff",fontWeight:700},children:[L??0," ðŸ’°"]}),e.jsxs("div",{style:{color:"#cfc"},children:[v??0," pts"]})]})]}),e.jsx("div",{className:"flex-1 px-4 overflow-y-auto",children:e.jsxs("div",{className:"mt-4 space-y-3",children:[m.map(t=>e.jsx("div",{className:`flex ${t.user.nombre==="Yo"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] px-3 py-2 rounded-lg ${t.user.nombre==="Yo"?"bg-primary text-white":"bg-card text-white"}`,children:[e.jsx("div",{className:"text-sm",children:t.text}),e.jsx("div",{className:"text-[10px] text-muted-foreground mt-1 text-right",children:new Date(t.timestamp).toLocaleTimeString()})]})},t.id)),e.jsx("div",{ref:x})]})}),e.jsx("div",{className:"fixed bottom-20 left-4 right-4 bg-transparent",children:e.jsxs("button",{onClick:()=>{if(!f){i?.({title:"Inicia sesiÃ³n para jugar",duration:2e3});return}if(v<E){i?.({title:`Necesitas ${E} pts para jugar`,duration:2200});return}y(!0)},style:{background:"linear-gradient(90deg,#ff66cc,#7b2cff)",border:"none",color:"#fff",padding:"8px 12px",borderRadius:12,fontWeight:800,cursor:"pointer"},title:`Jugar ruleta (${E} pts)`,children:["ðŸŽ¯ Ruleta (",E," pts)"]})}),e.jsx("div",{className:"fixed bottom-4 left-4 right-4 bg-transparent",children:e.jsx("div",{style:{display:"flex",gap:8,alignItems:"center"},children:e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flex:1},children:[e.jsx("input",{value:j,onChange:t=>b(t.target.value),className:"flex-1 rounded-2xl px-4 py-2 bg-card text-white outline-none",placeholder:"Escribe un mensaje...",onKeyDown:t=>{t.key==="Enter"&&S()}}),e.jsx(A,{onClick:S,size:"sm",variant:"secondary",children:e.jsx(Y,{className:"w-4 h-4"})})]})})}),e.jsx(q,{open:T,costPoints:E,userPoints:v,onClose:()=>y(!1),onPlay:C})]})};export{Q as default};
