import{u as R,r as o,j as t,X as b}from"./index-DjpR8ErO.js";import{B as f}from"./button-BhxATLcX.js";import{B as k}from"./BottomNav-CKB_DAjf.js";import{l as E}from"./index-CA1CrNgP.js";import{M as y}from"./music-2-C6UYKzIP.js";const r=E("http://localhost:5002",{transports:["websocket"]}),D=()=>{const x=R(),[S,h]=o.useState(!1),[l,g]=o.useState(""),d=o.useRef(null),c=o.useRef({}),n=o.useRef(null);o.useEffect(()=>{r.on("connect",()=>console.log("Socket streamer:",r.id)),r.on("stream-answer",async e=>{const a=c.current[e.from];a&&(console.log("ðŸ“© Recibida ANSWER del viewer:",e.from),await a.setRemoteDescription(e.answer))}),r.on("ice-candidate",async e=>{const a=c.current[e.from];a&&e.candidate&&await a.addIceCandidate(e.candidate)})},[]);const j=async()=>{const e=JSON.parse(localStorage.getItem("usuario")||"{}");if(!e.id_usuario){alert("Debes iniciar sesiÃ³n");return}const s=await(await fetch("http://localhost:5002/streams/crear",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id_streamer:e.id_usuario,titulo:"Mi Stream"})})).json();console.log("STREAM BACKEND:",s),localStorage.setItem("id_streamer_actual",e.id_usuario),localStorage.setItem("sesion_actual",s.streamId),console.log("âš¡ STREAMER GUARDADO EN LOCALSTORAGE"),g(s.streamId),h(!0),r.emit("join_stream",{streamId:s.streamId,role:"streamer"});const i=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});n.current=i,d.current&&(d.current.srcObject=i),r.on("viewer-joined",async m=>{console.log("ðŸ‘¤ Nuevo viewer:",m);const u=N(m);i.getTracks().forEach(w=>{u.addTrack(w,i)});const p=await u.createOffer();await u.setLocalDescription(p),r.emit("stream-offer",{offer:p,to:m,from:r.id,streamId:s.streamId})}),alert(`ðŸ”— Comparte el enlace: ${s.link}`)},v=async()=>{try{console.log("â›” Deteniendo stream..."),n.current&&(n.current.getTracks().forEach(e=>e.stop()),n.current=null),Object.values(c.current).forEach(e=>e.close()),c.current={},l&&await fetch(`http://localhost:5002/streams/${l}/finalizar`,{method:"POST"}),h(!1),g(""),localStorage.removeItem("sesion_actual"),alert("Stream finalizado")}catch(e){console.error(e)}},N=e=>{const a=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});return a.onicecandidate=s=>{s.candidate&&r.emit("ice-candidate",{candidate:s.candidate,to:e,from:r.id,streamId:l})},c.current[e]=a,a};return t.jsxs("div",{className:"min-h-screen bg-background flex flex-col pb-20",children:[t.jsxs("div",{className:"flex items-center gap-2 p-4",children:[t.jsx(f,{variant:"ghost",size:"icon",onClick:()=>x(-1),children:t.jsx(b,{className:"w-6 h-6"})}),t.jsxs("div",{className:"flex-1 flex items-center bg-card rounded px-2",children:[t.jsx(y,{className:"w-5 h-5 text-muted-foreground mr-2"}),t.jsx("span",{className:"text-muted-foreground",children:"Agregar sonido..."})]})]}),t.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 mt-40",children:[t.jsx("video",{ref:d,autoPlay:!0,muted:!0,className:"w-64 h-64 rounded-full border-4 border-white bg-black"}),t.jsx("div",{className:"mt-4",children:S?t.jsx(f,{variant:"destructive",size:"icon",className:"w-20 h-20 rounded-full",onClick:v,children:"Detener"}):t.jsx(f,{variant:"secondary",size:"icon",className:"w-20 h-20 rounded-full",onClick:j,children:"Iniciar Stream"})})]}),t.jsx("div",{className:"mt-auto",children:t.jsx(k,{})})]})};export{D as default};
