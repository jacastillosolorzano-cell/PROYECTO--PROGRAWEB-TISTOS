import{u as E,r as n,j as t,X as y,B as h}from"./index-BfeCuy2-.js";import{B as g}from"./button-BMU80YEG.js";import{B as R}from"./BottomNav-DyPFc2ca.js";import{l as C}from"./index-CA1CrNgP.js";import{M as T}from"./music-2-BVpjD98f.js";const a=C(h,{transports:["websocket"]}),_=()=>{const w=E(),[v,p]=n.useState(!1),[x,j]=n.useState(""),u=n.useRef(null),i=n.useRef({}),m=n.useRef(null);n.useEffect(()=>(a.on("connect",()=>console.log("Socket streamer:",a.id)),a.on("stream-answer",async e=>{const r=i.current[e.from];r&&(console.log("ðŸ“© Recibida ANSWER del viewer:",e.from),await r.setRemoteDescription(e.answer))}),a.on("ice-candidate",async e=>{const r=i.current[e.from];r&&e.candidate&&await r.addIceCandidate(e.candidate)}),()=>{a.off("connect"),a.off("stream-answer"),a.off("ice-candidate")}),[]);const N=async()=>{const e=localStorage.getItem("usuario"),r=localStorage.getItem("authToken");if(!e||!r){alert("Debes iniciar sesiÃ³n para iniciar un stream");return}const l=JSON.parse(e);try{const s=await fetch(`${h}/streams/crear`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({titulo:"Mi Stream"})});if(!s.ok){const c=await s.json().catch(()=>({}));console.error("Error creando stream:",c),alert(c.error||"No se pudo crear el stream");return}const o=await s.json();console.log("STREAM BACKEND:",o),localStorage.setItem("id_streamer_actual",l.id_usuario),localStorage.setItem("sesion_actual",o.streamId),j(o.streamId),p(!0),a.emit("join_stream",{streamId:o.streamId,role:"streamer"});const d=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});m.current=d,u.current&&(u.current.srcObject=d),a.on("viewer-joined",async c=>{console.log("ðŸ‘¤ Nuevo viewer:",c);const f=I(c,o.streamId);d.getTracks().forEach(b=>{f.addTrack(b,d)});const S=await f.createOffer();await f.setLocalDescription(S),a.emit("stream-offer",{offer:S,to:c,from:a.id,streamId:o.streamId})}),alert(`ðŸ”— Comparte este enlace con tus viewers:
${o.link}`)}catch(s){console.error("Error al iniciar stream:",s),alert("Error inesperado al iniciar el stream")}},k=async()=>{try{console.log("â›” Deteniendo stream...");const e=localStorage.getItem("authToken");m.current&&(m.current.getTracks().forEach(r=>r.stop()),m.current=null),Object.values(i.current).forEach(r=>r.close()),i.current={},x&&e&&await fetch(`${h}/streams/${x}/finalizar`,{method:"POST",headers:{Authorization:`Bearer ${e}`}}).catch(r=>console.error("Error al finalizar stream:",r)),p(!1),j(""),localStorage.removeItem("sesion_actual"),alert("Stream finalizado")}catch(e){console.error(e)}},I=(e,r)=>{const l=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});return l.onicecandidate=s=>{s.candidate&&a.emit("ice-candidate",{candidate:s.candidate,to:e,from:a.id,streamId:r})},i.current[e]=l,l};return t.jsxs("div",{className:"min-h-screen bg-background flex flex-col pb-20",children:[t.jsxs("div",{className:"flex items-center gap-2 p-4",children:[t.jsx(g,{variant:"ghost",size:"icon",onClick:()=>w(-1),children:t.jsx(y,{className:"w-6 h-6"})}),t.jsxs("div",{className:"flex-1 flex items-center bg-card rounded px-2",children:[t.jsx(T,{className:"w-5 h-5 text-muted-foreground mr-2"}),t.jsx("span",{className:"text-muted-foreground",children:"Agregar sonido..."})]})]}),t.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 mt-40",children:[t.jsx("video",{ref:u,autoPlay:!0,muted:!0,className:"w-64 h-64 rounded-full border-4 border-white bg-black"}),t.jsx("div",{className:"mt-4",children:v?t.jsx(g,{variant:"destructive",size:"icon",className:"w-20 h-20 rounded-full",onClick:k,children:"Detener"}):t.jsx(g,{variant:"secondary",size:"icon",className:"w-20 h-20 rounded-full",onClick:N,children:"Iniciar Stream"})})]}),t.jsx("div",{className:"mt-auto",children:t.jsx(R,{})})]})};export{_ as default};
