import{u as y,r as a,j as t,X as k}from"./index-DlPx5m3U.js";import{B as f}from"./button-CLDMEjga.js";import{B as E}from"./BottomNav-DmSmFQpx.js";import{l as R}from"./index-CA1CrNgP.js";import{M as C}from"./music-2-ChURS2a6.js";const s=R("https://proyectoprogaweb-t.onrender.com",{transports:["websocket"]}),P=()=>{const j=y(),[O,T]=a.useState("foto"),[l,p]=a.useState(""),[S,g]=a.useState(!1),d=a.useRef(null),c=a.useRef({}),o=a.useRef(null);a.useEffect(()=>{s.on("connect",()=>console.log("Socket streamer:",s.id)),s.on("stream-answer",async e=>{const r=c.current[e.from];r&&(console.log("ðŸ“© Recibida ANSWER del viewer:",e.from),await r.setRemoteDescription(e.answer))}),s.on("ice-candidate",async e=>{const r=c.current[e.from];r&&e.candidate&&await r.addIceCandidate(e.candidate)})},[]);const w=async()=>{const e=JSON.parse(localStorage.getItem("usuario")||"{}");if(!e.id_usuario){alert("Debes iniciar sesiÃ³n");return}const n=await(await fetch("https://proyectoprogaweb-t.onrender.com/streams/crear",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id_streamer:e.id_usuario,titulo:"Mi Stream"})})).json();console.log("STREAM BACKEND:",n);const m=n.streamId;p(m),g(!0),s.emit("join_stream",{streamId:m,role:"streamer"});const h=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});o.current=h,d.current&&(d.current.srcObject=h),s.on("viewer-joined",async i=>{if(console.log("ðŸ‘¤ Nuevo viewer:",i),!o.current){console.error("NO STREAM DISPONIBLE!");return}const u=N(i);o.current.getTracks().forEach(b=>{u.addTrack(b,o.current)});const x=await u.createOffer();await u.setLocalDescription(x),console.log("ðŸ“¤ Enviando OFFER a viewer:",i),s.emit("stream-offer",{offer:x,to:i,from:s.id,streamId:m})}),alert(`ðŸ”— Comparte el enlace: ${n.link}`)},v=async()=>{try{console.log("â›” Deteniendo stream..."),o.current&&(o.current.getTracks().forEach(e=>e.stop()),o.current=null),Object.values(c.current).forEach(e=>{e.close()}),c.current={},l&&(await fetch(`https://proyectoprogaweb-t.onrender.com/streams/${l}/finalizar`,{method:"POST"}),console.log("âœ” SesiÃ³n finalizada en backend")),g(!1),p(""),alert("Stream finalizado")}catch(e){console.error("Error al detener stream:",e)}},N=e=>{const r=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});return r.onicecandidate=n=>{n.candidate&&s.emit("ice-candidate",{candidate:n.candidate,to:e,from:s.id,streamId:l})},c.current[e]=r,r};return t.jsxs("div",{className:"min-h-screen bg-background flex flex-col pb-20",children:[t.jsxs("div",{className:"flex items-center gap-2 p-4",children:[t.jsx(f,{variant:"ghost",size:"icon",onClick:()=>j(-1),children:t.jsx(k,{className:"w-6 h-6"})}),t.jsxs("div",{className:"flex-1 flex items-center bg-card rounded px-2",children:[t.jsx(C,{className:"w-5 h-5 text-muted-foreground mr-2"}),t.jsx("span",{className:"text-muted-foreground",children:"Agregar sonido..."})]})]}),t.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 mt-40",children:[t.jsx("video",{ref:d,autoPlay:!0,muted:!0,className:"w-64 h-64 rounded-full border-4 border-white bg-black"}),t.jsx("div",{className:"mt-4",children:S?t.jsx(f,{variant:"destructive",size:"icon",className:"w-20 h-20 rounded-full",onClick:v,children:"Detener"}):t.jsx(f,{variant:"secondary",size:"icon",className:"w-20 h-20 rounded-full",onClick:w,children:"Iniciar Stream"})})]}),t.jsx("div",{className:"mt-auto",children:t.jsx(E,{})})]})};export{P as default};
