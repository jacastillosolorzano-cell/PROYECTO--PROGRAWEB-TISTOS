import{u as k,r as o,j as t,X as E}from"./index-DMvVmigX.js";import{B as f}from"./button-C8xTd2BK.js";import{B as R}from"./BottomNav-BAP6mqVg.js";import{l as y}from"./index-CA1CrNgP.js";import{M as C}from"./music-2-DWEooF2F.js";const s=y("http://localhost:5002",{transports:["websocket"]}),P=()=>{const j=k(),[O,T]=o.useState("foto"),[l,h]=o.useState(""),[S,p]=o.useState(!1),d=o.useRef(null),c=o.useRef({}),a=o.useRef(null);o.useEffect(()=>{s.on("connect",()=>console.log("Socket streamer:",s.id)),s.on("stream-answer",async e=>{const r=c.current[e.from];r&&(console.log("ðŸ“© Recibida ANSWER del viewer:",e.from),await r.setRemoteDescription(e.answer))}),s.on("ice-candidate",async e=>{const r=c.current[e.from];r&&e.candidate&&await r.addIceCandidate(e.candidate)})},[]);const v=async()=>{const e=JSON.parse(localStorage.getItem("usuario")||"{}");if(!e.id_usuario){alert("Debes iniciar sesiÃ³n");return}const n=await(await fetch("http://localhost:5002/streams/crear",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id_streamer:e.id_usuario,titulo:"Mi Stream"})})).json();console.log("STREAM BACKEND:",n);const m=n.streamId;h(m),p(!0),s.emit("join_stream",{streamId:m,role:"streamer"});const g=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});a.current=g,d.current&&(d.current.srcObject=g),s.on("viewer-joined",async i=>{if(console.log("ðŸ‘¤ Nuevo viewer:",i),!a.current){console.error("NO STREAM DISPONIBLE!");return}const u=w(i);a.current.getTracks().forEach(b=>{u.addTrack(b,a.current)});const x=await u.createOffer();await u.setLocalDescription(x),console.log("ðŸ“¤ Enviando OFFER a viewer:",i),s.emit("stream-offer",{offer:x,to:i,from:s.id,streamId:m})}),alert(`ðŸ”— Comparte el enlace: ${n.link}`)},N=async()=>{try{console.log("â›” Deteniendo stream..."),a.current&&(a.current.getTracks().forEach(e=>e.stop()),a.current=null),Object.values(c.current).forEach(e=>{e.close()}),c.current={},l&&(await fetch(`http://localhost:5002/streams/${l}/finalizar`,{method:"POST"}),console.log("âœ” SesiÃ³n finalizada en backend")),p(!1),h(""),alert("Stream finalizado")}catch(e){console.error("Error al detener stream:",e)}},w=e=>{const r=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});return r.onicecandidate=n=>{n.candidate&&s.emit("ice-candidate",{candidate:n.candidate,to:e,from:s.id,streamId:l})},c.current[e]=r,r};return t.jsxs("div",{className:"min-h-screen bg-background flex flex-col pb-20",children:[t.jsxs("div",{className:"flex items-center gap-2 p-4",children:[t.jsx(f,{variant:"ghost",size:"icon",onClick:()=>j(-1),children:t.jsx(E,{className:"w-6 h-6"})}),t.jsxs("div",{className:"flex-1 flex items-center bg-card rounded px-2",children:[t.jsx(C,{className:"w-5 h-5 text-muted-foreground mr-2"}),t.jsx("span",{className:"text-muted-foreground",children:"Agregar sonido..."})]})]}),t.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 mt-40",children:[t.jsx("video",{ref:d,autoPlay:!0,muted:!0,className:"w-64 h-64 rounded-full border-4 border-white bg-black"}),t.jsx("div",{className:"mt-4",children:S?t.jsx(f,{variant:"destructive",size:"icon",className:"w-20 h-20 rounded-full",onClick:N,children:"Detener"}):t.jsx(f,{variant:"secondary",size:"icon",className:"w-20 h-20 rounded-full",onClick:v,children:"Iniciar Stream"})})]}),t.jsx("div",{className:"mt-auto",children:t.jsx(R,{})})]})};export{P as default};
