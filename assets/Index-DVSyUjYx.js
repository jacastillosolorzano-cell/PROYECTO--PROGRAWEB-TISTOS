import{e as w,B as M,r,j as e,X as _,a as R}from"./index-8_ugQpNr.js";import{M as U}from"./MenuRegalos-CoNvWIIl.js";import{B as C}from"./button-YV_cQbfs.js";import{l as A}from"./index-CA1CrNgP.js";import{M as E}from"./music-2-Ctd7uSBZ.js";import{B as O}from"./BottomNav-q0_g7zxr.js";import{H as $}from"./HeaderSaldo-DH0yNw0_.js";import"./GiftOverlay-CENQroJk.js";import"./coins-DA1eTFTc.js";const L=w("Heart",[["path",{d:"M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z",key:"c3ymky"}]]);const T=w("MessageCircle",[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]]);const P=w("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);const D=w("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]),v=A(M,{transports:["websocket"]}),H=s=>{const l=Math.floor((Date.now()-s)/1e3);if(l<60)return`${l}s`;const i=Math.floor(l/60);if(i<60)return`${i}m`;const a=Math.floor(i/60);return a<24?`${a}h`:`${Math.floor(a/24)}d`},B=()=>{try{const s=localStorage.getItem("usuario");return s?JSON.parse(s):null}catch{return null}},J=({onClose:s,sessionId:l,onSendMessage:i})=>{const[a,c]=r.useState(""),[u,m]=r.useState([]),x=220,g=B(),j=r.useRef(null),b=r.useRef(null),p=`comments_stream_${l||"global"}`;r.useEffect(()=>{try{const t=localStorage.getItem(p);t&&m(JSON.parse(t))}catch{}},[l]),r.useEffect(()=>{try{localStorage.setItem(p,JSON.stringify(u))}catch{}},[u,p]),r.useEffect(()=>{j.current?.focus()},[]),r.useEffect(()=>{b.current&&(b.current.scrollTop=b.current.scrollHeight)},[u]),r.useEffect(()=>{if(!l)return;const t=d=>{if(d.streamId!==l)return;console.log("ðŸ’¬ Recibido mensaje REAL:",d);const f={id:crypto.randomUUID(),user:d.nombre,nivelNombre:d.nivelNombre,text:d.text,likes:0,createdAt:Date.now()};m(k=>[...k,f])};return v.on("chat:message",t),()=>{v.off("chat:message",t)}},[l]);const N=async()=>{const t=a.trim();if(!(!t||t.length>x)&&(c(""),i&&i(t),!(!l||!g?.id_usuario)))try{await fetch(`${M}/sesiones/${l}/mensajes`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id_espectador:g.id_usuario,contenido:t})})}catch(d){console.error("Error enviando mensaje al backend:",d)}},y=t=>{m(d=>d.map(f=>f.id===t?{...f,likes:f.likes+1}:f))};return e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex justify-center items-end",onClick:s,"aria-modal":"true",role:"dialog",children:e.jsxs("div",{className:"bg-background w-full max-w-2xl h-[75%] rounded-t-2xl grid grid-rows-[auto_1fr_auto] overflow-hidden shadow-xl mb-16",onClick:t=>t.stopPropagation(),children:[e.jsxs("header",{className:"flex items-center justify-between border-b p-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-muted flex items-center justify-center font-bold",children:"ðŸ’¬"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold",children:"Comentarios"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[u.length," comentarios"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-right mr-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Comentando como"}),e.jsx("div",{className:"text-sm font-medium",children:g?.nombre||g?.email||"Invitado"})]}),e.jsx(C,{variant:"ghost",size:"icon",onClick:s,children:e.jsx(_,{className:"w-5 h-5"})})]})]}),e.jsx("div",{ref:b,className:"overflow-y-auto p-4 space-y-3",children:u.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"AÃºn no hay comentarios. Â¡SÃ© el primero!"}):u.map(t=>e.jsxs("div",{className:"flex gap-3 items-start",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-pink-500 to-yellow-400 flex items-center justify-center text-white font-bold",children:t.user.charAt(0).toUpperCase()}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"font-semibold text-sm",children:t.user}),t.nivelNombre&&e.jsx("span",{className:"text-[10px] font-semibold px-2 py-[2px] rounded-full bg-purple-700/80 text-white",children:t.nivelNombre}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Â· ",H(t.createdAt)]})]}),e.jsx("div",{className:"text-sm mt-1",children:t.text}),e.jsxs("div",{className:"flex items-center gap-4 mt-2 text-xs text-muted-foreground",children:[e.jsxs("button",{onClick:()=>y(t.id),className:"flex items-center gap-1 text-rose-500",children:[e.jsx(L,{className:"w-4 h-4"}),e.jsx("span",{children:t.likes})]}),e.jsx("button",{onClick:()=>{c(`@${t.user} `),j.current?.focus()},children:"Responder"})]})]})]},t.id))}),e.jsxs("footer",{className:"flex items-center gap-2 border-t p-4 pb-6",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("input",{ref:j,type:"text",placeholder:"AÃ±ade un comentario...",value:a,onChange:t=>c(t.target.value),onKeyDown:t=>t.key==="Enter"&&N(),className:"w-full bg-muted border rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary",maxLength:x}),e.jsxs("div",{className:"flex justify-between text-xs mt-1 text-muted-foreground",children:[e.jsxs("span",{className:a.length>x?"text-rose-500":"",children:[a.length,"/",x]}),e.jsx("span",{children:"Pulsa Enter para enviar"})]})]}),e.jsx(C,{onClick:N,disabled:!a.trim()||a.length>x,children:"Publicar"})]})]})})},V=({video:s,isActive:l})=>{const[i,a]=r.useState(!1),[c,u]=r.useState(s.likes),m=r.useRef(null),[x,g]=r.useState(!1),[j,b]=r.useState(null),[p,N]=r.useState(null),[y,t]=r.useState(!1);r.useEffect(()=>{m.current&&(l?m.current.play().catch(n=>console.warn("No se pudo reproducir el video:",n)):(m.current.pause(),m.current.currentTime=0))},[l]),r.useEffect(()=>{if(!l||!s.sessionId)return;const n=localStorage.getItem("usuario");if(n)try{const o=JSON.parse(n);v.emit("chat:join",{streamId:s.sessionId,userId:o.id_usuario,nombre:o.nombre??"Viewer"}),console.log("ðŸ‘‹ Viewer unido al chat del stream",s.sessionId,"como",o.nombre)}catch(o){console.error("Error al parsear usuario:",o)}},[l,s.sessionId]),r.useEffect(()=>{const n=o=>{console.log("ðŸŽ‰ level:up recibido",o),b(o.orden),N(o.nivel||null),t(!0);const h=setTimeout(()=>{t(!1)},3e3);return()=>clearTimeout(h)};return v.on("level:up",n),()=>{v.off("level:up",n)}},[]);const d=n=>{if(!n.trim()||!s.sessionId)return;const o=localStorage.getItem("usuario");if(!o){alert("Debes iniciar sesiÃ³n para comentar");return}try{const h=JSON.parse(o),S={streamId:s.sessionId,userId:h.id_usuario,nombre:h.nombre??"Viewer",text:n.trim(),timestamp:new Date().toISOString()};v.emit("chat:message",S),console.log("ðŸ“¤ chat:message enviado",S)}catch(h){console.error("Error al enviar mensaje de chat:",h)}},f=()=>{a(n=>{const o=!n;return u(h=>o?h+1:Math.max(0,h-1)),o})},k=({streamerId:n})=>null,I=n=>n>=1e6?(n/1e6).toFixed(1)+"M":n>=1e3?(n/1e3).toFixed(1)+"K":n.toString();return e.jsxs("div",{className:"snap-item relative h-screen w-screen bg-black",children:[y&&e.jsxs("div",{className:"fixed top-16 left-1/2 -translate-x-1/2 z-50 bg-purple-600/90 text-white px-4 py-2 rounded-2xl text-sm shadow-lg",children:["ðŸŽ‰ Â¡Subiste al"," ",p?`nivel ${p}`:`nivel ${j??""}`,"!"]}),e.jsxs("div",{className:"absolute inset-0",children:[e.jsx("video",{ref:m,className:"h-screen w-screen object-cover",loop:!0,muted:!0,playsInline:!0,poster:`https://picsum.photos/1080/1920?random=${s.id}`,children:e.jsx("source",{src:s.videoUrl,type:"video/mp4"})}),e.jsx("div",{className:"absolute inset-0 gradient-overlay"})]}),e.jsx("button",{className:"absolute inset-0 flex items-center justify-center z-10 group",tabIndex:-1,style:{pointerEvents:"none"},children:e.jsx("div",{className:"opacity-0 group-active:opacity-100 transition-opacity duration-200",children:e.jsx(P,{className:"w-20 h-20 text-white drop-shadow-2xl",fill:"white"})})}),e.jsxs("div",{className:"absolute right-4 bottom-24 z-30 flex flex-col gap-6",children:[e.jsx("div",{className:"mb-2",children:e.jsx(k,{streamerId:s.streamerId})}),s.streamerId&&e.jsx("div",{className:"mb-2",children:e.jsx(U,{streamerId:s.streamerId})}),e.jsx("div",{className:"flex flex-col items-center",children:e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:s.avatar,alt:s.username,className:"w-12 h-12 rounded-full border-2 border-white"}),e.jsx("button",{className:"absolute -bottom-2 left-1/2 -translate-x-1/2 w-6 h-6 rounded-full bg-primary flex items-center justify-center text-white text-xl font-bold",children:"+"})]})}),e.jsxs("button",{onClick:f,className:"flex flex-col items-center gap-1",children:[e.jsx(L,{className:`w-8 h-8 transition-all ${i?"fill-primary text-primary animate-heart-pop":"text-white"}`}),e.jsx("span",{className:"text-white text-xs font-semibold text-shadow",children:I(c)})]}),e.jsxs("button",{onClick:()=>g(!0),className:"flex flex-col items-center gap-1",children:[e.jsx(T,{className:"w-8 h-8 text-white"}),e.jsx("span",{className:"text-white text-xs font-semibold text-shadow",children:I(s.comments)})]}),e.jsxs("button",{className:"flex flex-col items-center gap-1",children:[e.jsx(D,{className:"w-8 h-8 text-white"}),e.jsx("span",{className:"text-white text-xs font-semibold text-shadow",children:I(s.shares)})]}),e.jsx("button",{className:"flex flex-col items-center gap-1",children:e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center",children:e.jsx(E,{className:"w-5 h-5 text-white"})})})]}),e.jsxs("div",{className:"absolute bottom-24 left-4 right-20 z-20 animate-slide-up",children:[e.jsxs("h3",{className:"text-white font-bold text-lg mb-1 text-shadow flex items-center gap-2",children:["@",s.username,j&&e.jsxs("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full bg-purple-700/80 text-[10px] font-semibold",children:["Tu nivel:"," ",p||`Lvl ${j}`]})]}),e.jsx("p",{className:"text-white text-sm mb-2 text-shadow line-clamp-2",children:s.caption}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4 text-white"}),e.jsx("p",{className:"text-white text-xs text-shadow truncate",children:s.music})]})]}),x&&e.jsx(J,{sessionId:s.sessionId??(typeof s.id=="string"?s.id:String(s.id)),onClose:()=>g(!1),onSendMessage:d})]})},z=[{id:"1",videoUrl:"https://samplelib.com/mp4/sample-5s.mp4",username:"traveler_soul",avatar:"https://api.dicebear.com/7.x/avataaars/svg?seed=Felix",caption:"Chasing sunsets ðŸŒ… #travel #nature",likes:12400,comments:234,shares:89,music:"Summer Vibes â€¢ Chill Beats",sessionId:"session-1",streamerId:"streamer-1"},{id:"2",videoUrl:"https://www.w3schools.com/html/movie.mp4",username:"urban_explorer",avatar:"https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka",caption:"City lights never sleep ðŸŒƒ #citylife #night",likes:23100,comments:456,shares:123,music:"Neon Dreams â€¢ Synthwave",sessionId:"session-2",streamerId:"streamer-2"},{id:"3",videoUrl:"https://www.w3schools.com/html/mov_bbb.mp4",username:"ocean_lover",avatar:"https://api.dicebear.com/7.x/avataaars/svg?seed=Lily",caption:"Ocean therapy ðŸŒŠ #beach #relax",likes:34500,comments:678,shares:234,music:"Ocean Waves â€¢ Nature Sounds",sessionId:"session-3",streamerId:"streamer-3"},{id:"4",videoUrl:"https://filesamples.com/samples/video/mp4/sample_640x360.mp4",username:"mountain_climber",avatar:"https://api.dicebear.com/7.x/avataaars/svg?seed=Max",caption:"Reaching new heights â›°ï¸ #adventure #hiking",likes:18900,comments:345,shares:167,music:"Epic Journey â€¢ Orchestral",sessionId:"session-4",streamerId:"streamer-4"}],F=()=>{const[s,l]=r.useState(0),i=r.useRef(null);return r.useEffect(()=>{const a=i.current;if(!a)return;const c=()=>{const u=a.scrollTop,m=window.innerHeight,x=Math.round(u/m);l(x)};return a.addEventListener("scroll",c),()=>a.removeEventListener("scroll",c)},[]),e.jsx("div",{ref:i,className:"h-screen overflow-y-auto snap-y snap-mandatory",children:z.map((a,c)=>e.jsx(V,{video:a,isActive:c===s},a.id))})},se=()=>{const s=R();return r.useEffect(()=>{if(!localStorage.getItem("usuario")){s("/login",{replace:!0});return}},[s]),e.jsxs("div",{className:"relative min-h-screen bg-background",children:[e.jsx($,{}),e.jsx(F,{}),e.jsx(O,{})]})};export{se as default};
