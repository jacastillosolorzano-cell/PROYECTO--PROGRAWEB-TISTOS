import{e as A,a as P,r as a,j as t,X as C,B as g}from"./index-8_ugQpNr.js";import{B as m}from"./button-YV_cQbfs.js";import{B as U}from"./BottomNav-q0_g7zxr.js";import{l as V}from"./index-CA1CrNgP.js";import{G}from"./GiftOverlay-CENQroJk.js";import{M as _}from"./music-2-Ctd7uSBZ.js";const J=A("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]),r=V(g,{transports:["websocket"]}),W=()=>{const I=P(),[j,v]=a.useState(!1),[b,N]=a.useState(""),[w,y]=a.useState([]),[O,R]=a.useState(null),[E,k]=a.useState(!1),[d,T]=a.useState(null),[z,f]=a.useState(!1),x=a.useRef(null),n=a.useRef({}),h=a.useRef(null);a.useEffect(()=>(r.on("connect",()=>console.log("Socket streamer:",r.id)),r.on("stream-answer",async e=>{const s=n.current[e.from];s&&(console.log("ðŸ“© Response del viewer:",e.from),await s.setRemoteDescription(e.answer))}),r.on("ice-candidate",async e=>{const s=n.current[e.from];s&&e.candidate&&await s.addIceCandidate(e.candidate)}),r.on("chat:message",e=>{y(s=>[...s,e])}),r.on("gift:received",e=>{console.log("ðŸŽ regalo recibido:",e),R({nombre:e.viewerName||e.usuario||"Espectador",regalo:e.multiplicador&&e.multiplicador>1?`${e.regalo} x${e.multiplicador}`:e.regalo,imagen:e.imagen,multiplicador:e.multiplicador}),k(!0)}),()=>{r.off("connect"),r.off("stream-answer"),r.off("ice-candidate"),r.off("chat:message"),r.off("gift:received")}),[]);const B=async()=>{const e=localStorage.getItem("usuario"),s=localStorage.getItem("authToken");if(!e||!s){alert("Debes iniciar sesiÃ³n para iniciar un stream");return}const c=JSON.parse(e);try{const o=await fetch(`${g}/streams/crear`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({titulo:"Mi Stream"})});if(!o.ok){const l=await o.json().catch(()=>({}));alert(l.error||"No se pudo crear el stream");return}const i=await o.json();N(i.streamId),v(!0),y([]),T(i.link),f(!0),r.emit("join_stream",{streamId:i.streamId,role:"streamer"}),r.emit("chat:join",{streamId:i.streamId,userId:c.id_usuario,nombre:c.nombre??"Streamer"});const u=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});h.current=u,x.current&&(x.current.srcObject=u),r.on("viewer-joined",async l=>{console.log("ðŸ‘¤ Viewer:",l);const p=M(l,i.streamId);u.getTracks().forEach(L=>p.addTrack(L,u));const S=await p.createOffer();await p.setLocalDescription(S),r.emit("stream-offer",{offer:S,to:l,from:r.id,streamId:i.streamId})})}catch(o){console.error("Error al iniciar stream:",o)}},M=(e,s)=>{const c=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});return c.onicecandidate=o=>{o.candidate&&r.emit("ice-candidate",{candidate:o.candidate,to:e,from:r.id,streamId:s})},n.current[e]=c,c},$=async()=>{try{const e=localStorage.getItem("authToken");h.current&&h.current.getTracks().forEach(s=>s.stop()),Object.values(n.current).forEach(s=>s.close()),n.current={},b&&e&&await fetch(`${g}/streams/${b}/finalizar`,{method:"POST",headers:{Authorization:`Bearer ${e}`}}),v(!1),N(""),localStorage.removeItem("sesion_actual")}catch(e){console.error(e)}},D=async()=>{if(d)try{await navigator.clipboard.writeText(d),alert("Link copiado al portapapeles âœ…")}catch(e){console.error("Error al copiar link:",e),alert("No se pudo copiar, copia el enlace manualmente.")}};return t.jsxs("div",{className:"min-h-screen bg-background flex flex-col pb-20",children:[t.jsx(G,{gift:O,visible:E,onClose:()=>k(!1)}),t.jsxs("div",{className:"flex items-center gap-2 p-4",children:[t.jsx(m,{variant:"ghost",size:"icon",onClick:()=>I(-1),children:t.jsx(C,{className:"w-6 h-6"})}),t.jsxs("div",{className:"flex-1 flex items-center bg-card rounded px-2",children:[t.jsx(_,{className:"w-5 h-5 text-muted-foreground mr-2"}),t.jsx("span",{className:"text-muted-foreground",children:"Agregar sonido..."})]})]}),t.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 mt-40 relative",children:[t.jsx("video",{ref:x,autoPlay:!0,muted:!0,className:"w-64 h-64 rounded-full border-4 border-white bg-black"}),t.jsx("div",{className:"mt-4",children:j?t.jsx(m,{variant:"destructive",size:"icon",className:"w-20 h-20 rounded-full",onClick:$,children:"Detener"}):t.jsx(m,{variant:"secondary",size:"icon",className:"w-20 h-20 rounded-full",onClick:B,children:"Iniciar Stream"})}),j&&t.jsxs("div",{className:"absolute right-4 top-4 w-64 max-h-72 bg-black/70 text-white rounded-xl p-2 text-xs flex flex-col",children:[t.jsx("div",{className:"font-semibold mb-1",children:"Chat del stream"}),t.jsxs("div",{className:"flex-1 overflow-y-auto space-y-1",children:[w.length===0&&t.jsx("p",{className:"text-[10px] text-gray-300",children:"AÃºn no hay mensajes..."}),w.map((e,s)=>t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-purple-300 font-bold text-[10px]",children:e.nivelNombre?e.nivelNombre:`Lvl ${e.nivelOrden??1}`}),t.jsxs("span",{className:"font-semibold text-white",children:[e.nombre,":"]}),t.jsx("span",{className:"text-gray-200",children:e.text})]},s))]})]})]}),z&&d&&t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:t.jsxs("div",{className:"bg-background rounded-xl p-4 mx-4 w-full max-w-md space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("h2",{className:"text-lg font-semibold",children:"Comparte tu stream"}),t.jsx("button",{onClick:()=>f(!1),className:"p-1",children:t.jsx(C,{className:"w-4 h-4"})})]}),t.jsx("p",{className:"text-xs text-muted-foreground break-all",children:d}),t.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[t.jsx(m,{variant:"outline",onClick:()=>f(!1),children:"Cerrar"}),t.jsxs(m,{onClick:D,children:[t.jsx(J,{className:"w-4 h-4 mr-1"}),"Copiar link"]})]})]})}),t.jsx("div",{className:"mt-auto",children:t.jsx(U,{})})]})};export{W as default};
